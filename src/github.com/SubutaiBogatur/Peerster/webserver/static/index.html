<!DOCTYPE html>
<body>

<div id="frame">
    <div>
        <h3>
            this gossiper
        </h3>

        <div id="gossiper-name">
        </div>

        <div id="gossiper-id" style="margin-bottom: 10px">
        </div>

        <input type="text" id="gossiper-text-input" placeholder="New gossiper name..."/>
        <button id="gossiper-name-button">
            Change name
        </button>
    </div>

    <div id="peers">
        <h3>
            known peers
        </h3>

        <ul id="peers-list">
        </ul>

        <input type="text" id="peer-input" placeholder="New peer ip:port ..."/>
        <button id="add-peer-button">
            Add peer
        </button>
    </div>

    <div id="messages">
        <h3>
            messages
        </h3>

        <ul id="messages-list">
        </ul>

        <input type="text" id="message-input" placeholder="New message to gossip..."/>
        <button id="send-message-button">
            Send message
        </button>
    </div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>

    // init fields:

    callGetGossiperName();
    callGetID();
    document.getElementById("gossiper-name-button").onclick = changeGossiperNameOnClick;
    callGetPeers();
    document.getElementById("add-peer-button").onclick = addNewPeerOnClick;
    document.getElementById("send-message-button").onclick = sendMessageOnClick;
    callGetMessages();

    var timer = setInterval(updateAllFields, 1000 * 1); // update everything once in timeout

    function updateAllFields() {
        callGetGossiperName();
        callGetID();
        callGetPeers();
        callGetMessages();
    }

    function sendMessageOnClick() {
        callSendMessage();
        callGetMessages();
        callGetID();
    }

    function callGetMessages() {
        function gotMessages(msgs, status, dunno) {
            list = document.getElementById("messages-list")
            while (list.hasChildNodes()) {
                list.removeChild(list.firstChild)
            }
            var i;
            for (i = 0; i < msgs.length; i++) {
                // console.log(msgs);
                list.appendChild(document.createTextNode(msgs[i].OriginalName + " - " + msgs[i].ID + " - " + msgs[i].Text));
                list.appendChild(document.createElement("br"));
            }
        }
        jQuery.ajax({
            method: "GET",
            url: "/getMessages",
            success: gotMessages
        })
    }

    function callSendMessage() {
        var msg = document.getElementById("message-input").value;
        jQuery.ajax({
            method: "POST",
            url: "/sendMessage",
            data: msg
        });
        document.getElementById("message-input").value = "";
    }

    function addNewPeerOnClick() {
        callAddPeer();
        callGetPeers();
    }

    function callGetPeers() {
        function gotPeers(peers, status, dunno) {
            list = document.getElementById("peers-list")
            while (list.hasChildNodes()) {
                list.removeChild(list.firstChild)
            }
            var i;
            for (i = 0; i < peers.length; i++) {
                list.appendChild(document.createTextNode(peers[i].IP + ":" + peers[i].Port));
                list.appendChild(document.createElement("br"));
            }
        }
        jQuery.ajax({
            method: "GET",
            url: "/getPeers",
            success: gotPeers
        });
    }

    function callAddPeer() {
        var newPeer = document.getElementById("peer-input").value;
        jQuery.ajax({
            method: "POST",
            url: "/addPeer",
            data: newPeer
        });
        document.getElementById("peer-input").value = "";
    }

    function changeGossiperNameOnClick() {
        callSetGossiperName();
        callGetGossiperName();
        callGetID();
    }

    function callSetGossiperName() {
        var newName = document.getElementById("gossiper-text-input").value;
        jQuery.ajax({
            method: "POST",
            url: "/setGossiperName",
            data: newName
        });
        document.getElementById("gossiper-text-input").value = "";
    }

    function callGetGossiperName() {
        function gotNewName(name, status, dunno) {
            document.getElementById("gossiper-name").innerHTML = "name: " + name;
        }
        jQuery.ajax({
            method: "GET",
            url: "/getGossiperName",
            success: gotNewName
        });
    }

    function callGetID() {
        function gotID(id, status, dunno) {
            document.getElementById("gossiper-id").innerHTML = "id: " + id;
        }

        jQuery.ajax({
            method: "GET",
            url: "/getGossiperID",
            success: gotID
        });
    }


</script>
</body>
</html>
